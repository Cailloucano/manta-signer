<!DOCTYPE html>
<html lang="en">
  <head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Manta Signer</title>
    <style>
      body {
        margin: 0;
      }
      h2 {
        margin-top: 0;
      }
      main {
        align-items: center;
        display: flex;
        height: 100vh;
        justify-content: center;
        text-align: center;
        overflow: hidden;
        border-radius: 0.75em;
        background-color: wheat;
      }
      #mnemonic {
        padding: 3em;
      }
    </style>
  </head>
  <body>
    <main data-tauri-drag-region>
      <div>
      <h2>Manta Signer</h2>
        <div id="create-account" hidden>
          <h3>Create Account</h3>
          <div id="create-account-form">
            <label for="new-password">Password:</label>
            <input id="new-password" type="password" name="password" minlength="8" size="30" onchange="getMnemonic()" required>
            <input id="submit" type="submit" value="Submit" onclick="getMnemonic()">
          </div>
          <h4 id="mnemonic-header" hidden>Mnemonic</h4>
          <p id="mnemonic" hidden></p>
          <input id="close" type="submit" value="Close" onclick="endConnect()" hidden>
        </div>
        <div id="authorize" hidden>
          <h3>Authorize Transaction</h3>
          <label for="known-password">Password:</label>
          <input id="known-password" type="password" name="password" minlength="8" size="30" onchange="loadPassword()" required>
          <input id="approve" type="submit" value="Approve" onclick="loadPassword()">
          <hr>
          <input type="submit" value="DECLINE" onclick="clearPassword()">
        </div>
      </div>
    </main>
    <script>
      window.__TAURI__.invoke("connect").then(event => {
        switch(event) {
          case "create-account":
            document.getElementById("create-account").hidden = false;
            break;
          default:
            endConnect();
            break;
        }
      });

      function getMnemonic() {
        let password = document.getElementById("new-password");
        if (password.reportValidity()) {
          let promise = window.__TAURI__.invoke("get_mnemonic", { password: password.value });
          password.value = "";
          document.getElementById("create-account-form").hidden = true;
          document.getElementById("mnemonic-header").hidden = false;
          document.getElementById("mnemonic").hidden = false;
          document.getElementById("mnemonic").innerText = "...";
          promise.then(event => {
            document.getElementById("mnemonic").innerText = event;
            document.getElementById("close").hidden = false;
          });
        }
      }

      function endConnect() {
        window.__TAURI__.invoke("end_connect").then(() => {
          document.getElementById("create-account").hidden = true;
          document.getElementById("authorize").hidden = false;
        });
        window.__TAURI__.event.listen("authorize", event => {
          // TODO: Show the prompt to the user.
          console.log(event);
        });
      }

      function loadPassword() {
        let password = document.getElementById("known-password");
        if (password.reportValidity()) {
          let promise = window.__TAURI__.invoke("load_password", { password: password.value });
          password.value = "";
          promise.then(() => {});
        }
      }

      function clearPassword() {
        document.getElementById("known-password").value = "";
        window.__TAURI__.invoke("clear_password").then(() => {});
      }
    </script>
  </body>
</html>
